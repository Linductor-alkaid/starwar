# 星际防卫战 - 后端开发说明文档

## 文档版本
- 版本号：v1.0
- 创建日期：2025年
- 作者：Linductor

---

## 目录
1. [项目概述](#项目概述)
2. [技术栈](#技术栈)
3. [数据库设计](#数据库设计)
4. [API接口设计](#api接口设计)
5. [后端架构设计](#后端架构设计)
6. [开发环境搭建](#开发环境搭建)
7. [功能模块开发](#功能模块开发)
8. [部署说明](#部署说明)

---

## 项目概述

### 项目背景
星际防卫战是一个基于HTML5 Canvas的太空射击类网页游戏。在原始版本管理员，用户可以在本地游玩，但成绩无法保存和分享。本次开发旨在为游戏添加后端服务，实现用户系统、排行榜和讨论区功能。

### 功能需求
根据课程设计要求，本系统需要实现以下核心功能：

1. **用户系统**
   - 用户注册
   - 用户登录
   - 个人信息管理
   - 密码加密存储

2. **游戏数据管理**
   - 游戏成绩保存
   - 历史成绩查询

3. **排行榜系统**
   - 实时排行榜展示
   - 按分数/等级排序
   - 分页查询

4. **讨论区功能**
   - 发布帖子
   - 回复帖子
   - 帖子列表查询
   - 热门帖子推荐

### 项目目标
- 提供稳定可靠的后端API服务
- 支持高并发访问
- 保障数据安全
- 易于维护和扩展

---

## 技术栈

### 后端技术
- **开发语言**：Java 8
- **开发框架**：Spring Boot 2.x
- **数据库**：MySQL 8.0
- **ORM框架**：MyBatis
- **服务器**：Tomcat 9
- **构建工具**：Maven

### 前端技术（补充说明）
- **框架**：Vue 2.x
- **UI组件**：Element UI
- **HTTP客户端**：Axios

### 开发工具
- **IDE**：IntelliJ IDEA
- **数据库管理**：MySQL Workbench
- **API测试**：Postman
- **版本控制**：Git

---

## 数据库设计

### 数据库概述
数据库名称：`star_war_db`
字符集：utf8mb4
排序规则：utf8mb4_unicode_ci

### 数据表设计

#### 1. 用户表（user）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 说明 |
|--------|----------|------|------|------|------|
| id | BIGINT | - | 是 | 是 | 用户ID，自增 |
| username | VARCHAR | 50 | 否 | 是 | 用户名，唯一 |
| password | VARCHAR | 255 | 否 | 是 | 密码（加密后） |
| email | VARCHAR | 100 | 否 | 是 | 邮箱，唯一 |
| nickname | VARCHAR | 50 | 否 | 否 | 昵称 |
| avatar | VARCHAR | 255 | 否 | 否 | 头像URL |
| created_at | DATETIME | - | 否 | 是 | 创建时间 |
| updated_at | DATETIME | - | 否 | 是 | 更新时间 |

**索引设计**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_username (username)
- UNIQUE KEY uk_email (email)

**建表SQL**：
```sql
CREATE TABLE `user` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `password` VARCHAR(255) NOT NULL COMMENT '密码',
  `email` VARCHAR(100) NOT NULL COMMENT '邮箱',
  `nickname` VARCHAR(50) DEFAULT NULL COMMENT '昵称',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### 2. 游戏记录表（game_record）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 说明 |
|--------|----------|------|------|------|------|
| id | BIGINT | - | 是 | 是 | 记录ID |
| user_id | BIGINT | - | 否 | 是 | 用户ID |
| score | INT | - | 否 | 是 | 得分 |
| level | INT | - | 否 | 是 | 等级 |
| play_time | INT | - | 否 | 是 | 游戏时长（秒） |
| record_date | DATETIME | - | 否 | 是 | 记录时间 |

**建表SQL**：
```sql
CREATE TABLE `game_record` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `score` INT NOT NULL COMMENT '得分',
  `level` INT NOT NULL COMMENT '等级',
  `play_time` INT NOT NULL COMMENT '游戏时长（秒）',
  `record_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '记录时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_score` (`score`),
  CONSTRAINT `fk_game_record_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='游戏记录表';
```

#### 3. 帖子表（post）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 说明 |
|--------|----------|------|------|------|------|
| id | BIGINT | - | 是 | 是 | 帖子ID |
| user_id | BIGINT | - | 否 | 是 | 发布者ID |
| title | VARCHAR | 200 | 否 | 是 | 帖子标题 |
| content | TEXT | - | 否 | 是 | 帖子内容 |
| view_count | INT | - | 否 | 是 | 浏览次数 |
| reply_count | INT | - | 否 | 是 | 回复次数 |
| status | TINYINT | - | 否 | 是 | 状态（1:正常 0:删除） |
| created_at | DATETIME | - | 否 | 是 | 创建时间 |
| updated_at | DATETIME | - | 否 | 是 | 更新时间 |

**建表SQL**：
```sql
CREATE TABLE `post` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '帖子ID',
  `user_id` BIGINT NOT NULL COMMENT '发布者ID',
  `title` VARCHAR(200) NOT NULL COMMENT '帖子标题',
  `content` TEXT NOT NULL COMMENT '帖子内容',
  `view_count` INT NOT NULL DEFAULT 0 COMMENT '浏览次数',
  `reply_count` INT NOT NULL DEFAULT 0 COMMENT '回复次数',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态（1:正常 0:删除）',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_post_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='帖子表';
```

#### 4. 回复表（reply）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 说明 |
|--------|----------|------|------|------|------|
| id | BIGINT | - | 是 | 是 | 回复ID |
| post_id | BIGINT | - | 否 | 是 | 帖子ID |
| user_id | BIGINT | - | 否 | 是 | 回复者ID |
| content | TEXT | - | 否 | 是 | 回复内容 |
| parent_id | BIGINT | - | 否 | 否 | 父回复ID（用于回复评论） |
| status | TINYINT | - | 否 | 是 | 状态（1:正常 0:删除） |
| created_at | DATETIME | - | 否 | 是 | 创建时间 |
| updated_at | DATETIME | - | 否 | 是 | 更新时间 |

**建表SQL**：
```sql
CREATE TABLE `reply` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '回复ID',
  `post_id` BIGINT NOT NULL COMMENT '帖子ID',
  `user_id` BIGINT NOT NULL COMMENT '回复者ID',
  `content` TEXT NOT NULL COMMENT '回复内容',
  `parent_id` BIGINT DEFAULT NULL COMMENT '父回复ID',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态（1:正常 0:删除）',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_post_id` (`post_id`),
  KEY `idx_user_id` (`user_id`),
  CONSTRAINT `fk_reply_post` FOREIGN KEY (`post_id`) REFERENCES `post` (`id`),
  CONSTRAINT `fk_reply_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='回复表';
```

### 数据库初始化脚本

完整的数据库初始化脚本请参考 `docs/database/init.sql` 文件。

---

## API接口设计

### 接口规范
- **请求方式**：RESTful API
- **数据格式**：JSON
- **字符编码**：UTF-8
- **接口前缀**：`/api/v1`

### 统一响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

### 接口列表

#### 1. 用户相关接口

**1.1 用户注册**
- **接口地址**：`POST /api/v1/auth/register`
- **请求参数**：
```json
{
  "username": "testuser",
  "password": "123456",
  "email": "test@example.com",
  "nickname": "测试用户"
}
```
- **响应示例**：
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "id": 1,
    "username": "testuser"
  }
}
```

**1.2 用户登录**
- **接口地址**：`POST /api/v1/auth/login`
- **请求参数**：
```json
{
  "username": "testuser",
  "password": "123456"
}
```
- **响应示例**：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userId": 1,
    "username": "testuser"
  }
}
```

**1.3 获取用户信息**
- **接口地址**：`GET /api/v1/user/info`
- **请求头**：`Authorization: Bearer {token}`
- **响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "testuser",
    "nickname": "测试用户",
    "avatar": "http://example.com/avatar.jpg"
  }
}
```

#### 2. 游戏记录接口

**2.1 保存游戏记录**
- **接口地址**：`POST /api/v1/game/record`
- **请求头**：`Authorization: Bearer {token}`
- **请求参数**：
```json
{
  "score": 1500,
  "level": 5,
  "playTime": 120
}
```

**2.2 获取个人游戏历史**
- **接口地址**：`GET /api/v1/game/history?page=1&size=10`
- **请求头**：`Authorization: Bearer {token}`

**2.3 获取排行榜**
- **接口地址**：`GET /api/v1/game/leaderboard?page=1&size=20`
- **响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,
    "list": [
      {
        "rank": 1,
        "userId": 5,
        "username": "top_player",
        "score": 5000,
        "level": 10,
        "recordDate": "2024-01-15 10:30:00"
      }
    ]
  }
}
```

#### 3. 讨论区接口

**3.1 发布帖子**
- **接口地址**：`POST /api/v1/post/create`
- **请求头**：`Authorization: Bearer {token}`
- **请求参数**：
```json
{
  "title": "游戏攻略分享",
  "content": "分享一下我的游戏心得..."
}
```

**3.2 获取帖子列表**
- **接口地址**：`GET /api/v1/post/list?page=1&size=10`
- **响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 50,
    "list": [
      {
        "id": 1,
        "title": "游戏攻略分享",
        "content": "...",
        "author": "testuser",
        "viewCount": 100,
        "replyCount": 5,
        "createdAt": "2024-01-15 10:30:00"
      }
    ]
  }
}
```

**3.3 获取帖子详情**
- **接口地址**：`GET /api/v1/post/detail/{postId}`

**3.4 回复帖子**
- **接口地址**：`POST /api/v1/post/reply`
- **请求头**：`Authorization: Bearer {token}`
- **请求参数**：
```json
{
  "postId": 1,
  "content": "说得很好！",
  "parentId": null
}
```

---

## 后端架构设计

### 项目结构
```
star-war-backend/
├── src/main/java/
│   └── com/starwar/
│       ├── StarWarApplication.java       # 启动类
│       ├── config/                       # 配置类
│       │   ├── CorsConfig.java          # 跨域配置
│       │   ├── MyBatisConfig.java       # MyBatis配置
│       │   └── SwaggerConfig.java       # API文档配置
│       ├── controller/                   # 控制器层
│       │   ├── AuthController.java
│       │   ├── UserController.java
│       │   ├── GameController.java
│       │   └── PostController.java
│       ├── service/                      # 服务层
│       │   ├── UserService.java
│       │   ├── GameService.java
│       │   └── PostService.java
│       ├── mapper/                       # 数据访问层
│       │   ├── UserMapper.java
│       │   ├── GameRecordMapper.java
│       │   └── PostMapper.java
│       ├── entity/                       # 实体类
│       │   ├── User.java
│       │   ├── GameRecord.java
│       │   └── Post.java
│       ├── dto/                          # 数据传输对象
│       │   ├── RegisterDTO.java
│       │   ├── LoginDTO.java
│       │   └── GameRecordDTO.java
│       ├── vo/                           # 视图对象
│       │   ├── UserVO.java
│       │   └── LeaderboardVO.java
│       ├── common/                       # 公共类
│       │   ├── Result.java              # 统一返回结果
│       │   ├── ResultCode.java          # 返回码枚举
│       │   └── PageResult.java          # 分页结果
│       └── util/                         # 工具类
│           ├── JwtUtil.java             # JWT工具
│           └── PasswordUtil.java        # 密码加密工具
├── src/main/resources/
│   ├── application.yml                  # 应用配置
│   ├── mapper/                          # MyBatis映射文件
│   │   ├── UserMapper.xml
│   │   ├── GameRecordMapper.xml
│   │   └── PostMapper.xml
│   └── db/                              # 数据库脚本
│       └── init.sql
└── pom.xml                              # Maven依赖配置
```

### 技术选型说明

1. **Spring Boot**：简化Spring应用的开发，自动配置，快速开发
2. **MyBatis**：轻量级持久层框架，SQL映射灵活
3. **MySQL**：开源关系型数据库，稳定可靠
4. **JWT**：无状态的用户认证方案
5. **Swagger**：API文档自动生成工具

---

## 开发环境搭建

### 1. 安装JDK 8
- 下载地址：Oracle官网或OpenJDK
- 配置环境变量：`JAVA_HOME`、`PATH`
- 验证安装：`java -version`

### 2. 安装Maven
- 下载地址：https://maven.apache.org/download.cgi
- 配置环境变量：`MAVEN_HOME`、`PATH`
- 验证安装：`mvn -version`

### 3. 安装MySQL 8.0
- 下载地址：MySQL官网
- 配置root密码
- 创建数据库：`CREATE DATABASE star_war_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`
- 执行初始化脚本：`source docs/database/init.sql`

### 4. 安装IntelliJ IDEA
- 下载地址：https://www.jetbrains.com/idea/download
- 教育邮箱可申请免费许可证
- 安装插件：Lombok, MyBatis Plugin

### 5. 创建Spring Boot项目
1. 打开IDEA，选择 `File -> New -> Project`
2. 选择 `Spring Initializr`
3. 配置项目信息：
   - Group: `com.starwar`
   - Artifact: `star-war-backend`
   - Type: `Maven`
   - Java Version: `8`
4. 选择依赖：
   - Spring Web
   - MyBatis Framework
   - MySQL Driver
   - Lombok
5. 点击Finish创建项目

### 6. 配置pom.xml
在 `pom.xml` 中添加必要依赖（详见"依赖配置"章节）

---

## 开发步骤指南

### 第一阶段：基础搭建

#### 步骤1：配置项目依赖
在 `pom.xml` 中添加以下依赖：

```xml
<!-- MyBatis -->
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>2.2.0</version>
</dependency>

<!-- MySQL -->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.33</version>
</dependency>

<!-- Lombok -->
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <optional>true</optional>
</dependency>

<!-- JWT -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.9.1</version>
</dependency>

<!-- Swagger -->
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger2</artifactId>
    <version>2.9.2</version>
</dependency>
```

#### 步骤2：配置文件
创建 `src/main/resources/application.yml`：

```yaml
server:
  port: 8080

spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/star_war_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: your_password

mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.starwar.entity
  configuration:
    map-underscore-to-camel-case: true

logging:
  level:
    com.starwar: DEBUG
```

#### 步骤3：创建实体类
按照数据库设计创建对应的实体类（User, GameRecord, Post, Reply）

### 第二阶段：核心功能开发

#### 步骤1：开发用户模块
1. 创建UserMapper接口和对应的XML文件
2. 开发UserService业务逻辑（注册、登录、密码加密）
3. 创建AuthController处理HTTP请求
4. 实现JWT Token生成和验证

#### 步骤2：开发游戏记录模块
1. 创建GameRecordMapper接口
2. 开发GameService业务逻辑
3. 创建GameController处理请求
4. 实现排行榜查询逻辑

#### 步骤3：开发讨论区模块
1. 创建PostMapper和ReplyMapper接口
2. 开发PostService业务逻辑
3. 创建PostController处理请求
4. 实现帖子列表和详情查询

### 第三阶段：测试和优化

#### 步骤1：接口测试
使用Postman测试所有API接口，确保功能正常

#### 步骤2：性能优化
- 添加数据库索引
- 优化SQL查询
- 添加缓存机制

#### 步骤3：部署准备
- 打包项目：`mvn clean package`
- 部署到Tomcat服务器

---

## 部署说明

### 本地开发部署

1. **确保数据库已启动**
   ```bash
   # Windows
   net start MySQL80
   
   # Linux/Mac
   sudo service mysql start
   ```

2. **修改配置**
   - 编辑 `application.yml`，修改数据库连接信息

3. **运行项目**
   - 方式1：在IDEA中直接运行 `StarWarApplication.java`
   - 方式2：使用命令 `mvn spring-boot:run`

4. **访问测试**
   - API文档：http://localhost:8080/swagger-ui.html
   - 健康检查：http://localhost:8080/actuator/health

### 生产环境部署（Tomcat）

1. **打包项目**
   ```bash
   mvn clean package
   ```
   生成文件：`target/star-war-backend-1.0.0.war`

2. **部署到Tomcat**
   - 将war文件复制到Tomcat的 `webapps` 目录
   - 启动Tomcat：`./startup.sh` 或 `startup.bat`
   - 访问：http://your-server:8080/star-war-backend-1.0.0/

3. **配置Nginx反向代理**
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;
       
       location /api/ {
           proxy_pass http://localhost:8080;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
       }
   }
   ```

---

## 开发注意事项

### 1. 安全相关
- **密码加密**：使用BCrypt加密存储密码，绝不明文存储
- **SQL注入防护**：使用MyBatis的参数化查询
- **XSS防护**：对用户输入进行过滤和转义
- **Token过期**：JWT Token设置合理的过期时间
- **CORS配置**：正确配置跨域，避免所有来源

### 2. 代码规范
- 使用Lombok简化代码，减少getter/setter
- Controller层只负责接收请求和返回响应
- Service层处理业务逻辑
- Mapper层负责数据库操作
- 统一异常处理机制
- 统一的返回结果格式

### 3. 性能优化
- 数据库查询避免N+1问题
- 合理使用索引优化查询速度
- 大数据量查询使用分页
- 热门数据考虑使用缓存

### 4. 测试建议
- 每个接口都要编写测试用例
- 测试正常情况和异常情况
- 使用Postman进行接口测试
- 编写单元测试和集成测试

---

## 常见问题

### Q1: 启动时提示数据库连接失败
**A:** 检查MySQL服务是否启动，数据库名称是否正确，用户名密码是否正确

### Q2: Maven依赖下载失败
**A:** 配置国内Maven镜像源，或使用IDEA自带的Maven配置

### Q3: MyBatis扫描不到Mapper
**A:** 检查 `@MapperScan` 注解是否正确配置，mapper.xml文件位置是否正确

### Q4: 前端调用接口出现跨域错误
**A:** 配置CorsConfig，允许前端域名访问

### Q5: JWT Token验证失败
**A:** 检查Token是否过期，签名密钥是否正确

---

## 后续扩展建议

### 功能扩展
1. **游戏对战**：支持多人实时对战
2. **成就系统**：添加游戏成就和徽章
3. **邮件验证**：注册时发送验证邮件
4. **找回密码**：支持通过邮箱重置密码
5. **文件上传**：支持用户上传头像

### 技术优化
1. **Redis缓存**：缓存热门帖子和排行榜数据
2. **消息队列**：使用RabbitMQ处理异步任务
3. **全文搜索**：使用Elasticsearch实现帖子搜索
4. **日志系统**：使用Logback集成日志分析
5. **监控系统**：接入Prometheus + Grafana

---

## 总结

本开发文档为"星际防卫战"游戏后端系统提供了完整的开发指导，包括：

1. ✅ 完整的数据库设计方案
2. ✅ 详细的API接口规范
3. ✅ 清晰的项目架构设计
4. ✅ 逐步的开发环境搭建指南
5. ✅ 规范的开发步骤流程
6. ✅ 实用的部署和运维说明

按照本文档的指导，开发团队可以：
- 快速搭建开发环境
- 理解系统整体架构
- 按照步骤完成功能开发
- 正确部署和维护系统

### 开发时间规划建议
- **第1周**：环境搭建、数据库设计、基础框架搭建
- **第2周**：用户模块开发（注册、登录）
- **第3周**：游戏记录和排行榜模块开发
- **第4周**：讨论区模块开发
- **第5周**：测试、优化、文档完善

---

## 参考资料

- Spring Boot官方文档：https://spring.io/projects/spring-boot
- MyBatis官方文档：https://mybatis.org/mybatis-3/
- MySQL官方文档：https://dev.mysql.com/doc/
- Element UI文档：https://element.eleme.cn/
- Vue.js官方文档：https://cn.vuejs.org/

---

**文档版本**: v1.0  
**最后更新**: 2024年  
**维护者**: 开发团队

