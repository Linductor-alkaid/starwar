# å¼€å‘å¾…åŠæ¸…å• - é˜¶æ®µ4ï¼šæ¸¸æˆè®°å½•æ¨¡å—å¼€å‘

## ğŸ“‹ ä»»åŠ¡æ€»è§ˆ

æœ¬é˜¶æ®µåŒ…æ‹¬3ä¸ªä»»åŠ¡ï¼Œé¢„è®¡è€—æ—¶ï¼š3-5å¤©

---

## âœ… ä»»åŠ¡åˆ—è¡¨

### ä»»åŠ¡13ï¼šåˆ›å»ºGameRecordMapperæ¥å£å’ŒXML
- **ä¼˜å…ˆçº§**ï¼šğŸ”´ é«˜
- **é¢„è®¡æ—¶é—´**ï¼š4å°æ—¶
- **è´Ÿè´£äºº**ï¼šåç«¯å¼€å‘äººå‘˜
- **çŠ¶æ€**ï¼šâ³ å¾…å¼€å§‹

#### å…·ä½“æ­¥éª¤
1. [ ] åˆ›å»º `GameRecordMapper.java` æ¥å£
2. [ ] åˆ›å»º `mapper/GameRecordMapper.xml` æ˜ å°„æ–‡ä»¶
3. [ ] å®ç°æ’å…¥æ¸¸æˆè®°å½•æ–¹æ³•
4. [ ] å®ç°æŸ¥è¯¢ç”¨æˆ·å†å²è®°å½•æ–¹æ³•
5. [ ] å®ç°æŸ¥è¯¢æ’è¡Œæ¦œæ–¹æ³•

#### GameRecordMapperæ¥å£
```java
package com.starwar.mapper;

import com.starwar.entity.GameRecord;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import java.util.List;

@Mapper
public interface GameRecordMapper {
    // æ’å…¥æ¸¸æˆè®°å½•
    int insert(GameRecord gameRecord);
    
    // æŸ¥è¯¢ç”¨æˆ·å†å²è®°å½•ï¼ˆåˆ†é¡µï¼‰
    List<GameRecord> selectByUserId(@Param("userId") Long userId,
                                     @Param("offset") Integer offset,
                                     @Param("limit") Integer limit);
    
    // ç»Ÿè®¡ç”¨æˆ·è®°å½•æ€»æ•°
    int countByUserId(Long userId);
    
    // æŸ¥è¯¢æ’è¡Œæ¦œ
    List<GameRecord> selectLeaderboard(@Param("offset") Integer offset,
                                       @Param("limit") Integer limit);
    
    // ç»Ÿè®¡è®°å½•æ€»æ•°
    int countAll();
}
```

#### XMLæ˜ å°„æ–‡ä»¶å…³é”®æŸ¥è¯¢
```xml
<!-- æŸ¥è¯¢æ’è¡Œæ¦œ -->
<select id="selectLeaderboard" resultType="com.starwar.entity.GameRecord">
    SELECT gr.*, u.username, u.nickname
    FROM game_record gr
    LEFT JOIN user u ON gr.user_id = u.id
    ORDER BY gr.score DESC
    LIMIT #{offset}, #{limit}
</select>

<!-- æŸ¥è¯¢ç”¨æˆ·å†å² -->
<select id="selectByUserId" resultType="com.starwar.entity.GameRecord">
    SELECT * FROM game_record
    WHERE user_id = #{userId}
    ORDER BY record_date DESC
    LIMIT #{offset}, #{limit}
</select>
```

#### éªŒæ”¶æ ‡å‡†
- âœ… Mapperæ–¹æ³•å®šä¹‰å®Œæ•´
- âœ… SQLæŸ¥è¯¢æ­£ç¡®
- âœ… åˆ†é¡µæŸ¥è¯¢å®ç°
- âœ… æ’åºé€»è¾‘æ­£ç¡®

---

### ä»»åŠ¡14ï¼šå®ç°GameServiceä¸šåŠ¡é€»è¾‘
- **ä¼˜å…ˆçº§**ï¼šğŸ”´ é«˜
- **é¢„è®¡æ—¶é—´**ï¼š1å¤©
- **è´Ÿè´£äºº**ï¼šåç«¯å¼€å‘äººå‘˜
- **çŠ¶æ€**ï¼šâ³ å¾…å¼€å§‹

#### å…·ä½“æ­¥éª¤
1. [ ] åˆ›å»º `GameService.java` æ¥å£
2. [ ] åˆ›å»º `impl/GameServiceImpl.java` å®ç°ç±»
3. [ ] å®ç°ä¿å­˜æ¸¸æˆè®°å½•åŠŸèƒ½
4. [ ] å®ç°æŸ¥è¯¢ä¸ªäººå†å²è®°å½•åŠŸèƒ½
5. [ ] å®ç°æ’è¡Œæ¦œæŸ¥è¯¢åŠŸèƒ½

#### GameServiceæ¥å£
```java
package com.starwar.service;

import com.starwar.dto.GameRecordDTO;
import com.starwar.vo.GameRecordVO;
import com.starwar.common.PageResult;
import java.util.List;

public interface GameService {
    // ä¿å­˜æ¸¸æˆè®°å½•
    void saveRecord(Long userId, GameRecordDTO recordDTO);
    
    // æŸ¥è¯¢ä¸ªäººå†å²è®°å½•
    PageResult<GameRecordVO> getUserHistory(Long userId, Integer page, Integer size);
    
    // æŸ¥è¯¢æ’è¡Œæ¦œ
    PageResult<GameRecordVO> getLeaderboard(Integer page, Integer size);
}
```

#### GameServiceImplç¤ºä¾‹
```java
package com.starwar.service.impl;

import com.starwar.entity.GameRecord;
import com.starwar.mapper.GameRecordMapper;
import com.starwar.service.GameService;
import com.starwar.dto.GameRecordDTO;
import com.starwar.vo.GameRecordVO;
import com.starwar.common.PageResult;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class GameServiceImpl implements GameService {
    
    @Autowired
    private GameRecordMapper gameRecordMapper;
    
    @Override
    public void saveRecord(Long userId, GameRecordDTO recordDTO) {
        GameRecord record = new GameRecord();
        record.setUserId(userId);
        record.setScore(recordDTO.getScore());
        record.setLevel(recordDTO.getLevel());
        record.setPlayTime(recordDTO.getPlayTime());
        
        gameRecordMapper.insert(record);
    }
    
    @Override
    public PageResult<GameRecordVO> getUserHistory(Long userId, Integer page, Integer size) {
        Integer offset = (page - 1) * size;
        
        List<GameRecord> records = gameRecordMapper.selectByUserId(userId, offset, size);
        Integer total = gameRecordMapper.countByUserId(userId);
        
        // è½¬æ¢ä¸ºVO
        List<GameRecordVO> vos = records.stream()
            .map(this::convertToVO)
            .collect(Collectors.toList());
        
        return new PageResult<>(vos, total);
    }
    
    @Override
    public PageResult<GameRecordVO> getLeaderboard(Integer page, Integer size) {
        Integer offset = (page - 1) * size;
        
        List<GameRecord> records = gameRecordMapper.selectLeaderboard(offset, size);
        Integer total = gameRecordMapper.countAll();
        
        List<GameRecordVO> vos = records.stream()
            .map(this::convertToVO)
            .collect(Collectors.toList());
        
        return new PageResult<>(vos, total);
    }
    
    private GameRecordVO convertToVO(GameRecord record) {
        GameRecordVO vo = new GameRecordVO();
        vo.setId(record.getId());
        vo.setScore(record.getScore());
        vo.setLevel(record.getLevel());
        vo.setPlayTime(record.getPlayTime());
        vo.setRecordDate(record.getRecordDate());
        return vo;
    }
}
```

#### éªŒæ”¶æ ‡å‡†
- âœ… æ¸¸æˆè®°å½•èƒ½å¤Ÿæ­£ç¡®ä¿å­˜
- âœ… å†å²è®°å½•æŸ¥è¯¢æ­£ç¡®
- âœ… æ’è¡Œæ¦œæ’åºæ­£ç¡®
- âœ… åˆ†é¡µåŠŸèƒ½æ­£å¸¸
- âœ… DTOå’ŒVOè½¬æ¢æ­£ç¡®

---

### ä»»åŠ¡15ï¼šåˆ›å»ºGameControllerå¤„ç†è¯·æ±‚
- **ä¼˜å…ˆçº§**ï¼šğŸ”´ é«˜
- **é¢„è®¡æ—¶é—´**ï¼š3å°æ—¶
- **è´Ÿè´£äºº**ï¼šåç«¯å¼€å‘äººå‘˜
- **çŠ¶æ€**ï¼šâ³ å¾…å¼€å§‹

#### å…·ä½“æ­¥éª¤
1. [ ] åˆ›å»º `GameController.java`
2. [ ] å®ç°ä¿å­˜æ¸¸æˆè®°å½•æ¥å£
3. [ ] å®ç°æŸ¥è¯¢å†å²è®°å½•æ¥å£
4. [ ] å®ç°æ’è¡Œæ¦œæ¥å£
5. [ ] æ·»åŠ JWTè®¤è¯æ‹¦æˆª

#### GameControllerç¤ºä¾‹
```java
package com.starwar.controller;

import com.starwar.dto.GameRecordDTO;
import com.starwar.service.GameService;
import com.starwar.common.Result;
import com.starwar.common.PageResult;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/v1/game")
public class GameController {
    
    @Autowired
    private GameService gameService;
    
    @PostMapping("/record")
    public Result<?> saveRecord(@RequestHeader("Authorization") String token,
                               @RequestBody GameRecordDTO recordDTO) {
        Long userId = getUserIdFromToken(token);
        gameService.saveRecord(userId, recordDTO);
        return Result.success(null);
    }
    
    @GetMapping("/history")
    public Result<PageResult<?>> getHistory(@RequestHeader("Authorization") String token,
                                            @RequestParam(defaultValue = "1") Integer page,
                                            @RequestParam(defaultValue = "10") Integer size) {
        Long userId = getUserIdFromToken(token);
        return Result.success(gameService.getUserHistory(userId, page, size));
    }
    
    @GetMapping("/leaderboard")
    public Result<PageResult<?>> getLeaderboard(@RequestParam(defaultValue = "1") Integer page,
                                                @RequestParam(defaultValue = "20") Integer size) {
        return Result.success(gameService.getLeaderboard(page, size));
    }
    
    private Long getUserIdFromToken(String token) {
        // è§£æTokenè·å–ç”¨æˆ·ID
        return Long.parseLong(token); // ç®€åŒ–ç¤ºä¾‹
    }
}
```

#### éªŒæ”¶æ ‡å‡†
- âœ… ä¿å­˜è®°å½•æ¥å£å¯ä»¥æ­£å¸¸è®¿é—®
- âœ… å†å²è®°å½•æ¥å£è¿”å›æ­£ç¡®æ•°æ®
- âœ… æ’è¡Œæ¦œæ¥å£è¿”å›æ­£ç¡®æ•°æ®
- âœ… åˆ†é¡µå‚æ•°å¤„ç†æ­£ç¡®
- âœ… è®¤è¯æ‹¦æˆªæ­£å¸¸

---

## ğŸ“Š é˜¶æ®µè¿›åº¦ç»Ÿè®¡

- **å·²å®Œæˆä»»åŠ¡**ï¼š0 / 3
- **è¿›è¡Œä¸­ä»»åŠ¡**ï¼š0 / 3
- **å¾…å¼€å§‹ä»»åŠ¡**ï¼š3 / 3
- **æ•´ä½“è¿›åº¦**ï¼š0%

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ’è¡Œæ¦œæŸ¥è¯¢è€ƒè™‘æ·»åŠ ç¼“å­˜
2. **æ’åºè§„åˆ™**ï¼šæŒ‰åˆ†æ•°é™åºï¼Œåˆ†æ•°ç›¸åŒæ—¶æŒ‰æ—¶é—´å‡åº
3. **åˆ†é¡µè®¡ç®—**ï¼šoffset = (page - 1) * size
4. **æ•°æ®å®‰å…¨**ï¼šç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±çš„å†å²è®°å½•
5. **æ•°æ®éªŒè¯**ï¼šæ¸¸æˆæ•°æ®èŒƒå›´éªŒè¯

---

## ğŸ¯ å®Œæˆæ ‡å¿—

å½“ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶æ»¡è¶³æ—¶ï¼Œé˜¶æ®µ4å®Œæˆï¼š
- âœ… æ¸¸æˆè®°å½•èƒ½å¤ŸæˆåŠŸä¿å­˜
- âœ… èƒ½å¤ŸæŸ¥è¯¢ä¸ªäººæ¸¸æˆå†å²
- âœ… æ’è¡Œæ¦œåŠŸèƒ½æ­£å¸¸
- âœ… åˆ†é¡µåŠŸèƒ½æ­£å¸¸
- âœ… Postmanæµ‹è¯•é€šè¿‡

---

**ä¸Šä¸€é˜¶æ®µ**ï¼š[é˜¶æ®µ3ï¼šç”¨æˆ·æ¨¡å—å¼€å‘](å¼€å‘å¾…åŠæ¸…å•-é˜¶æ®µ3-ç”¨æˆ·æ¨¡å—å¼€å‘.md)  
**ä¸‹ä¸€é˜¶æ®µ**ï¼š[é˜¶æ®µ5ï¼šè®¨è®ºåŒºæ¨¡å—å¼€å‘](å¼€å‘å¾…åŠæ¸…å•-é˜¶æ®µ5-è®¨è®ºåŒºæ¨¡å—.md)

