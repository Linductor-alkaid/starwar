# 问题修复记录

本文档记录项目开发过程中遇到的问题及其解决方案。

---

## 问题 #1: CORS 跨域请求被阻止

### 问题描述

**错误信息：**
```
Access to XMLHttpRequest at 'http://localhost:8080/login' (redirected from 'http://localhost:8081/api/v1/game/leaderboard?page=1&size=20') 
from origin 'http://localhost:8081' has been blocked by CORS policy: 
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

**问题现象：**
- 前端 `http://localhost:8081` 访问后端 `http://localhost:8080` 时出现 CORS 错误
- 请求被重定向到 `/login`（说明 Spring Security 生效）
- 浏览器阻止了跨域请求

**问题原因：**
1. Spring Security 默认拦截所有请求
2. 未认证请求被重定向到 `/login` 页面
3. Spring Security 的 CORS 配置未生效，导致跨域请求被阻止
4. 即使配置了 `CorsConfig.java`，但 Spring Security 需要在 Security 配置中也启用 CORS

### 解决方案

**创建 Spring Security 配置类 `SecurityConfig.java`：**

位置：`backend/src/main/java/com/starwar/config/SecurityConfig.java`

**关键配置点：**

1. **启用 CORS 支持**
   ```java
   .cors()
   .and()
   ```

2. **配置 CORS 配置源**
   ```java
   @Bean
   public CorsConfigurationSource corsConfigurationSource() {
       CorsConfiguration configuration = new CorsConfiguration();
       configuration.setAllowedOrigins(Arrays.asList(
           "http://localhost:8081",
           "http://localhost:3000",
           "http://localhost:8080"
       ));
       configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
       configuration.setAllowedHeaders(Collections.singletonList("*"));
       configuration.setAllowCredentials(true);
       configuration.setMaxAge(3600L);
       
       UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
       source.registerCorsConfiguration("/api/**", configuration);
       return source;
   }
   ```

3. **配置公开接口（无需认证）**
   ```java
   .authorizeRequests()
       .antMatchers("/api/v1/auth/**").permitAll()
       .antMatchers("/api/v1/game/leaderboard").permitAll()
       .antMatchers("/api/v1/post/list").permitAll()
       .antMatchers("/api/v1/post/detail/**").permitAll()
       .antMatchers("/swagger-ui.html", "/swagger-ui/**", "/v3/api-docs/**", "/swagger-resources/**").permitAll()
       .anyRequest().authenticated()
   ```

4. **禁用默认登录表单重定向**
   ```java
   .formLogin().disable()
   ```

5. **配置无状态会话（使用 JWT）**
   ```java
   .sessionManagement()
       .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
   ```

**完整配置代码：**

详见：`backend/src/main/java/com/starwar/config/SecurityConfig.java`

### 验证步骤

1. 重新启动后端服务
   ```powershell
   cd backend
   mvn spring-boot:run
   ```

2. 前端访问 `/api/v1/game/leaderboard` 接口，确认不再出现 CORS 错误

3. 检查浏览器控制台，确认请求成功返回数据

### 相关文件

- `backend/src/main/java/com/starwar/config/SecurityConfig.java` - Spring Security 配置类
- `backend/src/main/java/com/starwar/config/CorsConfig.java` - CORS 配置类（已存在，但需要配合 Security 使用）

---

## 问题 #2: 讨论区功能优化与修复

### 问题 #2.1: 讨论区发布帖子面板需要优化

#### 问题描述

**问题现象：**
- 发布帖子对话框样式过于简单，与整体星空主题不协调
- 表单验证不完善
- 用户体验不佳

#### 解决方案

**优化发布帖子对话框样式：**

1. **对话框头部设计**
   - 添加图标和标题
   - 使用渐变背景和标题样式
   - 添加描述文字

2. **表单样式优化**
   - 优化输入框样式，使用毛玻璃效果
   - 改进标签显示，添加图标
   - 优化按钮样式和交互效果

3. **表单验证增强**
   - 标题至少需要3个字符
   - 内容至少需要10个字符
   - 添加提交状态反馈

**相关文件：**
- `frontend/src/views/Forum.vue`

---

### 问题 #2.2: 帖子详情页缺少回复列表显示

#### 问题描述

**问题现象：**
- 帖子详情页无法查看所有回复
- 缺少按楼层排列的回复列表
- 用户无法了解帖子的讨论情况

**问题原因：**
- 前端未实现回复列表展示功能
- 缺少获取回复列表的API调用

#### 解决方案

**1. 添加回复列表API方法：**

在 `frontend/src/api/post.js` 中添加：
```javascript
/**
 * 获取帖子回复列表
 */
export function getReplies(postId) {
  return request({
    url: `/post/replies/${postId}`,
    method: 'get'
  })
}
```

**2. 优化帖子详情页：**

- 使用与讨论区一致的星空主题样式
- 添加回复列表显示，按创建时间排序（楼层顺序）
- 每个回复显示楼层号（#1, #2, #3...）
- 优化回复输入框样式
- 添加回复成功后自动滚动到回复列表功能
- 显示作者信息（nickname 或 username）
- 添加时间格式化显示

**相关文件：**
- `frontend/src/api/post.js`
- `frontend/src/views/PostDetail.vue`

---

### 问题 #2.3: 发布面板标题栏字数限制显示白色背景

#### 问题描述

**问题现象：**
- 发布帖子对话框中，标题输入框的字数限制（如 "0/50"）显示有白色背景
- 内容文本域的字数限制显示正常（透明背景）
- 视觉不一致，影响美观

**问题原因：**
- Element UI 的 `el-input` 组件字数限制使用 `.el-input__count-inner` 类名
- CSS 选择器不完整，未覆盖到 `-inner` 变体
- 默认样式未完全覆盖

#### 解决方案

**修复CSS样式选择器：**

为 `.el-input__count-inner` 添加样式规则，确保背景透明：

```css
/* 标题输入框的字数限制样式（修复 inner 类名） */
::v-deep .create-dialog .form-input .el-input__count-inner,
::v-deep .create-dialog .form-input .el-input__suffix .el-input__count-inner,
::v-deep .create-dialog .form-input .el-input__suffix-inner .el-input__count-inner {
  color: rgba(255, 255, 255, 0.6) !important;
  background: transparent !important;
  background-color: transparent !important;
  background-image: none !important;
  box-shadow: none !important;
  border: none !important;
}
```

**关键点：**
- 添加 `-inner` 类名选择器
- 使用 `!important` 确保样式优先级
- 同时处理 `el-input__suffix` 和 `el-input__suffix-inner` 容器

**相关文件：**
- `frontend/src/views/Forum.vue`

---

### 问题 #2.4: 帖子回复数量显示与实际不符

#### 问题描述

**问题现象：**
- 数据库中已有测试帖子的回复数量（`reply_count` 字段）与实际回复数量不一致
- 显示的回复数量不准确，影响用户体验

**问题原因：**
- 使用 `post` 表中的 `reply_count` 字段，该字段可能因为历史数据或数据迁移导致不准确
- 未实时计算实际回复数量

#### 解决方案

**修改SQL查询，使用子查询实时计算回复数量：**

在 `backend/src/main/resources/mapper/PostMapper.xml` 中修改：

**1. 帖子列表查询：**
```xml
<select id="selectList" resultType="com.starwar.entity.Post">
    SELECT p.*, u.username,
           (SELECT COUNT(*) FROM reply r WHERE r.post_id = p.id AND r.status = 1) AS reply_count
    FROM post p
    LEFT JOIN user u ON p.user_id = u.id
    WHERE p.status = 1
    ORDER BY p.created_at DESC
    LIMIT #{offset}, #{limit}
</select>
```

**2. 帖子详情查询：**
```xml
<select id="selectById" resultType="com.starwar.entity.Post">
    SELECT p.*, u.username, u.nickname,
           (SELECT COUNT(*) FROM reply r WHERE r.post_id = p.id AND r.status = 1) AS reply_count
    FROM post p
    LEFT JOIN user u ON p.user_id = u.id
    WHERE p.id = #{id} AND p.status = 1
</select>
```

**技术说明：**
- 使用子查询 `(SELECT COUNT(*) FROM reply r WHERE r.post_id = p.id AND r.status = 1)` 实时计算回复数量
- 只统计状态为正常的回复（`r.status = 1`）
- 确保显示的回复数量始终与实际回复数量一致
- 不依赖 `post` 表中的 `reply_count` 字段

**相关文件：**
- `backend/src/main/resources/mapper/PostMapper.xml`

---

## 问题 #3: 退出登录时路由导航重复错误

### 问题描述

**错误信息：**
```
ERROR
Avoided redundant navigation to current location: "/".
NavigationDuplicated: Avoided redundant navigation to current location: "/".
    at createRouterError (webpack-internal:///./node_modules/vue-router/dist/vue-router.esm.js:2056:15)
    at createNavigationDuplicatedError (webpack-internal:///./node_modules/vue-router/dist/vue-router.esm.js:2026:15)
    at HTML5History.confirmTransition (webpack-internal:///./node_modules/vue-router/dist/vue-router.esm.js:2343:18)
    at HTML5History.transitionTo (webpack-internal:///./node_modules/vue-router/dist/vue-router.esm.js:2270:8)
    at HTML5History.push (webpack-internal:///./node_modules/vue-router/dist/vue-router.esm.js:2616:10)
    at VueRouter.push (webpack-internal:///./node_modules/vue-router/dist/vue-router.esm.js:3045:12)
    at VueComponent.handleLogout (webpack-internal:///./node_modules/@vue/vue-loader-v15/lib/index.js??vue-loader-options!./src/views/Home.vue?vue&type=script&lang=js:29:20)
```

**问题现象：**
- 在首页点击"退出登录"按钮时，控制台出现 `NavigationDuplicated` 错误
- 错误提示：`Avoided redundant navigation to current location: "/"`
- 虽然功能正常（用户已退出登录），但控制台报错影响调试体验

**问题原因：**
1. 在 `Home.vue` 的 `handleLogout` 方法中，退出登录后总是调用 `this.$router.push('/')` 导航到首页
2. 如果用户当前已经在首页（`/`），Vue Router 会检测到重复导航并抛出错误
3. Vue Router 3.x 版本默认不允许导航到当前路由位置，以避免不必要的导航操作

### 解决方案

**修改 `handleLogout` 方法，添加路由检查：**

在 `frontend/src/views/Home.vue` 中修改退出登录方法：

**修改前：**
```javascript
handleLogout() {
  this.$store.dispatch('user/logout')
  this.$message.success('已退出登录')
  this.$router.push('/')
}
```

**修改后：**
```javascript
handleLogout() {
  this.$store.dispatch('user/logout')
  this.$message.success('已退出登录')
  // 如果当前不在首页，才进行导航
  if (this.$route.path !== '/') {
    this.$router.push('/')
  }
}
```

**关键点：**
- 在导航前检查当前路由路径 `this.$route.path`
- 只有当不在首页（`/`）时才执行导航操作
- 如果已在首页，则跳过导航，避免重复导航错误
- 这样既保证了功能的正确性，又避免了控制台错误

**技术说明：**
- Vue Router 3.x 会检测并阻止导航到当前路由，这是框架的正常行为
- 通过条件判断可以优雅地处理这种情况
- 其他页面（如 Game.vue）中的 `router.push('/')` 通常不会有问题，因为用户通常不会在首页时触发这些操作

### 验证步骤

1. 启动前端服务
   ```bash
   cd frontend
   npm run serve
   ```

2. 在首页点击"退出登录"按钮
   - 确认用户成功退出登录
   - 确认控制台不再出现 `NavigationDuplicated` 错误

3. 在其他页面（如讨论区、游戏页面）退出登录
   - 确认能够正常跳转到首页
   - 确认功能正常

### 相关文件

- `frontend/src/views/Home.vue` - 首页组件，包含退出登录逻辑

---

## 问题模板（用于记录新问题）

### 问题 #X: [问题标题]

#### 问题描述

**错误信息：**
```
[错误信息内容]
```

**问题现象：**
- [现象1]
- [现象2]

**问题原因：**
1. [原因1]
2. [原因2]

#### 解决方案

[解决方案描述]

**相关文件：**
- [文件路径1]
- [文件路径2]

#### 验证步骤

1. [步骤1]
2. [步骤2]

---

